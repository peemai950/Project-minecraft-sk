# ---------------------------------------------------------
# FILE: RPG_System/03_Skill_Deck.sk
# SYSTEM: Skill Loadout (Fix Auto-Close & Slot Limit)
# VERSION: v2.0 (Dynamic Slot Limit)
# ---------------------------------------------------------

options:
    prefix: &8[&bDeck&8] &7
    DEFAULT_SLOTS: 3

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡∏Å‡∏¥‡∏• ---
function openSkillDeckGUI(p: player):
    set {_gui} to a chest inventory with 6 rows named "&1&lüéí ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏¥‡∏• (Skill Deck)"
    set {_uuid} to uuid of {_p}
    
    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 3)
    if {passive.max_slots::%{_uuid}%} is not set:
        set {passive.max_slots::%{_uuid}%} to {@DEFAULT_SLOTS}
    
    # 1. Background
    set {_glass} to gray stained glass pane named "&7"
    loop integers between 0 and 53:
        set slot loop-value of {_gui} to {_glass}
    
    # 2. ‡∏õ‡∏∏‡πà‡∏° Stats
    set {_xp} to total experience of {_p}
    set slot 49 of {_gui} to experience bottle named "&e&l‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏•‡πÄ‡∏ß‡∏• (Stats)" with lore "&7‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á", "&7(Strength / Defense / Agility)", "", "&fXP ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: &a%{_xp}% Points"

    # 3. ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏Å‡∏¥‡∏•
    set {_slot} to 10
    
    # ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß
    set {_equipped_count} to 0
    loop {passive.equipped::%{_uuid}%::*}:
        add 1 to {_equipped_count}
    
    loop {passive.skills::%{_uuid}%::*}:
        set {_skill_name} to loop-index
        set {_display_name} to loop-index
        replace all "Passive: " and " (" and ")" with "" in {_display_name}
        
        if {passive.equipped::%{_uuid}%::%{_skill_name}%} is set:
            set {_icon} to written book
            enchant {_icon} with unbreaking 1
            set {_status} to "&a&l‚úî ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà (Active)"
            set {_action} to "&e‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏≠‡∏î‡∏≠‡∏≠‡∏Å"
            set {_color} to "&a&l"
        else:
            set {_icon} to book
            set {_status} to "&7‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Inactive)"
            set {_action} to "&e‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á"
            set {_color} to "&f"
        
        set {_item} to {_icon} named "%{_color}%%{_skill_name}%"
        set lore of {_item} to "", {_status}, "", {_action}
        
        if {_slot} is 17 or 26 or 35 or 44:
            add 2 to {_slot}
        
        set slot {_slot} of {_gui} to {_item}
        add 1 to {_slot}
        
    # ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Slot
    set slot 4 of {_gui} to clock named "&6&l‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏™‡∏Å‡∏¥‡∏•: %{_equipped_count}%/%{passive.max_slots::%{_uuid}%}%" with lore "&7‡πÉ‡∏ä‡πâ‡πÉ‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏Å‡∏¥‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡πÑ‡∏î‡πâ"

    open {_gui} to {_p}

# --- Event ‡∏Ñ‡∏•‡∏¥‡∏Å ---
on inventory click:
    if name of event-inventory contains "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏¥‡∏• (Skill Deck)":
        cancel event
        
        if index of event-slot is 49:
            play sound "ui.button.click" at player
            close player's inventory
            wait 1 tick
            openStatsGUI(player)
            stop

        if type of event-item is book or written book:
            set {_skill_name} to uncolored name of event-item
            set {_uuid} to uuid of player
            replace all "‚úî " with "" in {_skill_name}
            
            if {passive.equipped::%{_uuid}%::%{_skill_name}%} is set:
                delete {passive.equipped::%{_uuid}%::%{_skill_name}%}
                play sound "ui.interface.click" at player
                openSkillDeckGUI(player)
            else:
                set {_current_slots} to 0
                loop {passive.equipped::%{_uuid}%::*}:
                    add 1 to {_current_slots}
                
                # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Max Slots
                if {passive.max_slots::%{_uuid}%} is not set:
                    set {passive.max_slots::%{_uuid}%} to {@DEFAULT_SLOTS}
                    
                if {_current_slots} >= {passive.max_slots::%{_uuid}%}:
                    play sound "block.note_block.bass" at player
                    send "{@prefix}&c‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏Å‡∏¥‡∏•‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß! (%{_current_slots}%/%{passive.max_slots::%{_uuid}%}%)" to player
                else:
                    set {passive.equipped::%{_uuid}%::%{_skill_name}%} to true
                    play sound "entity.experience_orb.pickup" at player
                    openSkillDeckGUI(player)