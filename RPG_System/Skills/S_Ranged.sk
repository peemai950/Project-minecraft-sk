# =========================================================
# MARKER SUMMARY (‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
# ---------------------------------------------------------
# [LINE 90] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠ ({_origin})
# [LINE 94-96] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡πÄ‡∏°‡∏ï‡∏£ ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏•‡∏π‡∏õ (Stop Loop)
# =========================================================

options:
    DMG_PER_LEVEL: 0.1
    # Settings
    eagle_velocity_mult: 1.5
    eagle_min_dist: 15
    eagle_dmg_bonus: 1.5
    frost_chance: 30%
    explosive_chance: 20%
    cost_magic: 1

on damage:
    if attacker is a player:
        if damage cause is projectile:
            set {_uuid} to uuid of attacker

            # --- Eagle Eye ---
            set {_s} to "Passive: ‡∏ï‡∏≤‡πÄ‡∏´‡∏¢‡∏µ‡πà‡∏¢‡∏ß (Eagle Eye)"
            if {passive.equipped::%{_uuid}%::%{_s}%} is set:
                if distance between attacker and victim >= {@eagle_min_dist}:
                    set damage to damage * {@eagle_dmg_bonus}
                    play sound "entity.arrow.hit_player" at attacker
                    send action bar "&6üèπ Eagle Eye! (x{@eagle_dmg_bonus})" to attacker

            # --- Frost Shot ---
            set {_s} to "Passive: ‡∏®‡∏£‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á (Frost Shot)"
            if {passive.equipped::%{_uuid}%::%{_s}%} is set:
                if chance of {@frost_chance}:
                    apply slowness 2 to victim for 3 seconds
                    play sound "block.glass.break" at victim

            # --- Explosive Shot ---
            set {_s} to "Passive: ‡∏ò‡∏ô‡∏π‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î (Explosive Shot)"
            if {passive.equipped::%{_uuid}%::%{_s}%} is set:
                if chance of {@explosive_chance}:
                    if attacker's food level >= {@cost_magic}:
                        remove {@cost_magic} from attacker's food level
                        create safe explosion of force 2 at location of victim
                        send action bar "&cüí• Boom!" to attacker

            # ########## [UPDATED] ARROW STORM (‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏±‡∏ö) ##########
            set {_s} to "Passive: ‡∏û‡∏≤‡∏¢‡∏∏‡∏•‡∏π‡∏Å‡∏®‡∏£ (Arrow Storm)"
            if {passive.equipped::%{_uuid}%::%{_s}%} is set:
                if metadata value "rain_arrow" of event-projectile is not set:
                    if chance of 30%: 
                        play sound "weather.rain.above" at victim
                        
                        # [NEW] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏ô‡∏¢‡∏¥‡∏á
                        set {_origin} to location of victim
                        
                        loop 50 times:
                            # [NEW] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡∏µ‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡πÄ‡∏°‡∏ï‡∏£ -> ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                            if distance between victim and {_origin} > 1.0:
                                stop loop
                            
                            wait 1 tick
                            
                            loop 15 times:
                                set {_loc} to location of victim
                                add (random number between 10 and 15) to y-coordinate of {_loc}
                                add (random number between -6 and 6) to x-coordinate of {_loc}
                                add (random number between -6 and 6) to z-coordinate of {_loc}
                                
                                spawn arrow at {_loc}
                                set {_arrow} to spawned entity
                                set shooter of {_arrow} to attacker
                                set metadata value "rain_arrow" of {_arrow} to true
                                set velocity of {_arrow} to vector(0, -5.0, 0)
            # ###########################################################

on shoot:
    if shooter is a player:
        set {_uuid} to uuid of shooter
        
        # --- Eagle Velocity ---
        set {_s} to "Passive: ‡∏ï‡∏≤‡πÄ‡∏´‡∏¢‡∏µ‡πà‡∏¢‡∏ß (Eagle Eye)"
        if {passive.equipped::%{_uuid}%::%{_s}%} is set:
            set velocity of projectile to velocity of projectile * {@eagle_velocity_mult}
            play sound "entity.arrow.shoot" with pitch 0.5 at shooter
        
        # --- Swift Step ---
        set {_s} to "Passive: ‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πâ‡∏≤‡∏ß‡∏ß‡∏≤‡∏¢‡∏∏ (Swift Step)"
        if {passive.equipped::%{_uuid}%::%{_s}%} is set:
            apply speed 2 to shooter for 4 seconds
            play sound "entity.bat.takeoff" at shooter

# --- Cleanup ---
on projectile hit:
    if metadata value "rain_arrow" of event-projectile is set:
        wait 3 seconds
        delete event-projectile

# --- ANTI-PICKUP ---
on pickup arrow:
    if metadata value "rain_arrow" of event-arrow is set:
        cancel event
        delete event-arrow